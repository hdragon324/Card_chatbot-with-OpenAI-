import streamlit as st
import json
from langchain_openai import ChatOpenAI

def recommend_my_model_test(user_content):
    
    with open('data/check_card_info-ver-4.json', 'r', encoding='utf-8') as json_file:
        check_card_data = json.load(json_file)

    with open('data/credit_card_info-ver-4.json', 'r', encoding='utf-8') as json_file:
        credit_card_data = json.load(json_file)

    base_template = f'''다음은 카드 추천 양식입니다.
        세부적인 설명이 없을 때는 데이터의 가장 첫번째 카드(1위)로 추천합니다.

        카드의 추천 양식은 아래의 양식을 참고하십시오.

        1. 추천카드의 이름, 혜택요약, 연회비 순서로 작성하십시오.
            1-1. 주요 혜택이 사용자의 어떤 습관과 연관이 있는지 순서 쌍으로 작성하십시오.
            1-2. 주요 혜택 중 연관이 없는 나머지 혜택에 대해 작성하십시오.
            
        1번의 예시입니다.
        - 추천 카드 : **KB국민 My WE:SH 카드**
        - 혜택 요약 : KB Pay 10% 할인, 음식점 10% 할인, 서비스팩 3개 중 1개 선택할인
        - 연회비: 국내전용 15,000원 - 모바일단독카드 9,000원, 해외겸용 15,000원 - 모바일단독카드 9,000원
        
        - 주요 혜택(매칭) :
                음식점 10% 할인) 사용자가 점심을 회사 근처 맛집에서 자주 먹기 때문에 음식점 할인 혜택이 있는 카드가 유리합니다.
                이동수단 10% 할인) 사용자가 주 5일 버스로 회사를 출퇴근하기 때문에 이동수단에 할인이 있는 카드를 추천합니다.

        - 매칭되지 않은 혜택: KB Pay 10% 할인, 서비스팩 3개 중 1개 선택할인 

        2. 다음으로 카드의 전반적인 평가에 대해 작성하십시오.
            2-1. 추천 카드의 혜택 이외에 고려할만한 혜택에 대해 추가 작성하십시오.

        2번의 예시입니다.

        이 카드는 음식점 할인, 통신요금 할인 및 디지털 구독 서비스 할인을 제공하여 사용자의 생활 습관과 잘 맞습니다. 또한, 해외 결제에 대한 혜택이 포함되어 있어 해외 웹툰 구매에도 유리할 수 있습니다.
        추가로 이 사용자의 생활 습관과 필요에 가장 적합한 신용카드를 추천하기 위해 다음과 같은 혜택을 고려할 수 있습니다:

        1) **주유 할인 또는 적립**: 자차를 이용해 출퇴근하고 주말 드라이브를 즐기므로 주유 할인이나 적립 혜택이 있는 카드가 적합합니다.
        2) **해외 웹툰 구매 혜택**: 해외 웹툰 구매를 즐기므로 해외 결제에 대한 할인이나 적립 혜택이 있는 카드가 좋습니다.
        3) **건강 및 웰니스 혜택**: 요가와 필라테스를 주기적으로 하며 유기농 식재료를 사용하므로 건강 및 웰니스 관련 혜택이 있는 카드가 유용합니다.
        4) **여행 혜택**: 부모님과의 여행 계획이 있으므로 여행 관련 혜택이 포함된 카드가 도움이 될 수 있습니다.

        ---------------------------------------------------------------------------------------------------------------------------------------
        ※※**추천 작성 시 주의사항** : 
        1. 주요 혜택 매칭을 할 때, 사용자의 습관의 카테고리와 주요 혜택과 연관된 걸 우선적으로 보고, 주요 혜택의 세부 설명에 연관된 걸 찾아줘

        안좋은 예시) 건강식을 자주 만들어 가족과 함께 식사를 즐기는 사용자에게는 마일리지 적립 혜택이 유용합니다.
        건강식이랑 마일리지는 직접적인 연관이 없습니다.

        2. 사용자 소비 패턴에 따른 논리적 연결 강화
        단순히 특정 카테고리를 소비한다고 해서 무조건 그 혜택을 추천하는 것이 아니라, 소비 동기와 실제 혜택 활용 가능성을 고려해야 합니다.

        "사용자의 소비 패턴과 혜택의 실제 활용 가능성을 고려하여 추천하라."
        "사용자가 특정 카테고리를 자주 소비하더라도, 그 소비 방식(예: 온라인/오프라인, 정기적/비정기적)이 혜택과 적절히 매칭되는지 검토하라."

        💡 예시 적용:

        "자택에서 식사하며 음식 재료를 온라인으로 구매하는 사용자는 음식점 할인보다 온라인 마트/배달 할인 혜택이 적합하다."
        "대도시 외곽에서 출퇴근하는 사용자는 대중교통 이용이 많다면 교통비 할인, 자가용 이용이 많다면 주유 할인 혜택이 유용하다."

        **그리고 카드 데이터의 없는 헤택을 만들어내지 마십시오. 추천할만한 카드가 없으면 그나마 비슷한 혜택의 카드를 가져와주세요**'''

    content = f'''당신은 소비 패턴을 분석하는 카드 추천 전문가입니다. 사용자의 소비 습관에 맞춰 가장 효율적인 카드를 추천합니다. 
        질문을 고려하여 체크카드 또는 신용카드를 추천해야 하며, 
        신용카드의 추천기준으로는

        **소득 안정성**: 신용카드는 신용도에 따라 한도가 설정되기 때문에, 정기적이고 안정적인 소득을 가진 사람이 적합합니다. 예를 들어, 월급을 받는 직장인이나 사업자가 이에 해당합니다.
        포인트/혜택 활용: 다양한 포인트 적립, 캐시백, 할인 혜택을 활용할 수 있습니다. 예를 들어, 자주 쇼핑을 하거나 여행을 즐기는 경우, 해당 분야에 특화된 혜택을 제공하는 카드를 추천할 수 있습니다.
        지출 관리 능력: 신용카드는 일정 기간 동안 결제하고 나중에 상환하는 방식이므로, 지출 관리 능력이 중요한 요소입니다. 월별로 계획적인 예산을 세우고, 적시에 결제할 수 있는 능력이 있는 사람에게 적합합니다.
        일시불/분할결제 선호도: 일시불 결제 또는 분할 결제 혜택을 선호하는 경우, 해당 조건을 잘 반영한 카드를 추천해야 합니다. 예를 들어, 고급 소비 성향이나 큰 금액의 지출을 분할 상환할 필요가 있는 경우 유리합니다.

        체크카드의 추천기준으로는

        **재정 관리 중요성**: 체크카드는 계좌에 있는 한도 내에서만 결제가 가능하므로, 소비를 통제하고 싶은 사람에게 적합합니다. 신용카드에 비해 즉시 결제되기 때문에 과도한 지출을 피하고 싶은 사람에게 유리합니다.
        매일 자주 사용하는 카드: 일상적인 소비에서 작고 빈번한 지출이 많은 사람에게 적합합니다. 예를 들어, 카페, 편의점, 대중교통 등에서 자주 결제하는 소비 성향이라면 체크카드가 적합할 수 있습니다.
        상환 부담을 피하고 싶은 사람: 신용카드는 대금 결제 후 일시불이나 할부 상환 방식을 선택해야 하지만, 체크카드는 즉시 결제되므로 상환에 대한 부담이 없습니다. 이로 인해 상환 계획 없이 즉시 결제가 가능한 카드를 원하는 소비자에게 유리합니다.
        간편한 관리 선호자: 체크카드는 신용카드에 비해 관리가 간편하고, 과소비를 방지하기 위해 필요한 사람에게 적합합니다.
        직업이 없는 사람(무직, 백수), 가진 재산이 부족한 사람은 체크카드가 적합합니다.

        기타 고려 사항으로
        **연회비 부담**: 신용카드는 카드사마다 연회비가 다르기 때문에 연회비가 부담스러운 사람은 혜택이 좋은 체크카드를 추천할 수 있습니다.
        적립 혜택 및 할인율: 신용카드는 다양한 적립 프로그램과 할인 혜택이 있지만, 혜택을 자주 활용하지 않는 소비자에게는 체감 혜택이 적을 수 있으므로 이 점도 고려해야 합니다.

        **답변은 단답으로 정확히 체크카드 아니면 신용카드 로만 대답하십시오.**'''

    # 체크카드 추천 챗봇의 페르소나
    check_content = f'''당신은 체크카드 추천 전문가입니다. 사용자의 소비 습관에 맞춰 가장 효율적인 카드를 추천합니다.
    다음 주어지는 체크카드 파일 중에서 추천해야 합니다. 사용자가 별 특징 없이 추천을 해달라고 해도 추천을 해줍니다.
    체크카드 : {check_card_data}
    작성 양식 : {base_template}'''


    # 신용카드 추천 챗봇의 페르소나
    credit_content = f'''당신은 신용카드 추천 전문가입니다. 사용자의 습관에 맞춰 가장 효율적인 카드를 추천합니다.
    다음 주어지는 신용카드 파일 중에서 추천해야 합니다. 사용자가 별 특징 없이 추천을 해달라고 해도 추천을 해줍니다.
    신용카드 : {credit_card_data}
    작성 양식 : {base_template}'''

    chat_model = ChatOpenAI(
        model_name='gpt-3.5-turbo',
        openai_api_key=st.secrets['OPENAI_API_KEY'],
        temperature=0.5
    )

    # 유저의 페르소나를 기반으로 체크카드 또는 신용카드를 추천
    response = chat_model.invoke([
        {'role': 'system', 'content': content},
        {'role': 'user', 'content': user_content}
    ])

    choice = response.content  # 응답 결과 저장
    print(choice)

    # 선택된 카드 유형에 따라 적절한 추천 메시지 생성
    if choice == '체크카드':
        final_response = chat_model.invoke([
            {'role': 'system', 'content': check_content},
            {'role': 'user', 'content': user_content}
        ])
        card_name = final_response.content.split('\n')[0].replace('**','').split(':')[1].strip()
        for data in check_card_data:
            if card_name in data:
                for k, v in data.items():
                    card_code = v['code']

    elif choice == '신용카드':
        final_response = chat_model.invoke([
            {'role': 'system', 'content': credit_content},
            {'role': 'user', 'content': user_content}
        ])
        card_name = final_response.content.split('\n')[0].replace('**','').split(':')[1].strip()
        for data in credit_card_data:
            if card_name in data:
                for k, v in data.items():
                    card_code = v['code']

    else:
        result = "추천 결과를 분석하는 데 문제가 발생했습니다."
        return result

    # 최종 추천 내용 반환
    result = final_response.content

    return result, card_code